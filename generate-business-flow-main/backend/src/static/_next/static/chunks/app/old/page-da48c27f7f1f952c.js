(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[997],{67:function(){},2061:function(){},5539:function(e,t,n){Promise.resolve().then(n.bind(n,2952))},2952:function(e,t,n){"use strict";n.d(t,{default:function(){return f}});var s=n(7437),o=n(2265);function l(){let[e,t]=(0,o.useState)(!1);return(0,s.jsx)("div",{className:"chat-section",id:"chat-section",children:(0,s.jsxs)("div",{className:"panel",id:"chat-panel",children:[(0,s.jsxs)("div",{className:"panel-header",children:[(0,s.jsxs)("span",{children:[(0,s.jsx)("i",{className:"fas fa-comments"})," BiT-Flow チャット"]}),(0,s.jsx)("span",{className:"panel-status",id:"chat-status",children:"待機中"})]}),(0,s.jsxs)("div",{className:"panel-content",style:{display:"flex",flexDirection:"column",height:"100%"},children:[(0,s.jsx)("div",{id:"chat-messages",style:{flex:1,overflowY:"auto",padding:16,border:"1px solid rgba(209, 213, 219, 0.3)",borderRadius:12,marginBottom:3,background:"rgba(249, 250, 251, 0.5)"}}),(0,s.jsxs)("div",{style:{display:"flex",gap:12,alignItems:"stretch",flexWrap:"wrap"},children:[(0,s.jsx)("textarea",{id:"prompt-input",placeholder:"業務フロー図を生成したい内容を入力してください。\n例: ECサイトの注文処理業務フローを描いて",style:{flex:1,resize:"none",height:60,border:"2px solid rgba(209, 213, 219, 0.3)",borderRadius:12,padding:12,fontSize:14,background:"rgba(255, 255, 255, 0.9)",fontFamily:"inherit"}}),(0,s.jsxs)("div",{style:{display:"flex",flexDirection:"column",gap:6},children:[(0,s.jsxs)("button",{className:"btn btn-primary",id:"generate-btn",style:{height:32,padding:"6px 16px"},children:[(0,s.jsx)("span",{id:"btn-text",children:"送信"}),(0,s.jsx)("div",{id:"btn-spinner",className:"loading-spinner",style:{display:"none"}})]}),(0,s.jsx)("button",{className:"btn btn-secondary",id:"clear-btn",style:{height:26,padding:"4px 12px",fontSize:12},children:"クリア"})]})]}),(0,s.jsxs)("div",{className:"attachment-area",children:[(0,s.jsxs)("div",{className:"attachment-controls",children:[(0,s.jsxs)("div",{className:"attachment-label",children:[(0,s.jsx)("i",{className:"fas fa-paperclip"}),"添付ファイル"]}),(0,s.jsxs)("button",{className:"btn btn-ghost",id:"attach-btn",type:"button",children:[(0,s.jsx)("i",{className:"fas fa-plus"}),"ファイルを選択"]}),(0,s.jsxs)("button",{type:"button",className:"attachment-hint-toggle","aria-expanded":e,onClick:()=>t(e=>!e),children:[(0,s.jsx)("i",{className:"fas fa-question-circle","aria-hidden":!0}),(0,s.jsx)("span",{className:"sr-only",children:"対応ファイル形式を表示"})]}),e?(0,s.jsx)("span",{className:"attachment-hint",children:"対応: .pdf /.txt / .md / .csv / .docx / .xls / .xlsx （最大2MB・複数可）"}):null,(0,s.jsx)("input",{type:"file",id:"file-input",multiple:!0,accept:".txt,.md,.csv,.pdf,.docx,.xls,.xlsx",style:{display:"none"}})]}),(0,s.jsx)("div",{id:"attachment-list",className:"attachment-list empty",children:(0,s.jsx)("span",{className:"attachment-placeholder",children:"現在、添付ファイルはありません"})})]})]})]})})}function a(){return(0,s.jsxs)("div",{className:"panel",id:"diagram-panel",children:[(0,s.jsxs)("div",{className:"panel-header",children:[(0,s.jsxs)("span",{children:[(0,s.jsx)("i",{className:"fas fa-project-diagram"})," フロー図"]}),(0,s.jsx)("span",{className:"panel-status",id:"diagram-status",children:"待機中"})]}),(0,s.jsxs)("div",{className:"panel-content",children:[(0,s.jsxs)("button",{className:"download-diagram-btn",id:"download-svg-btn",title:"drawioファイルをダウンロード",children:[(0,s.jsx)("i",{className:"fas fa-download"}),(0,s.jsx)("span",{children:"ダウンロード"}),(0,s.jsx)("div",{className:"download-tooltip",children:"ダウンロードしました！"})]}),(0,s.jsx)("div",{id:"flow-diagram",className:"placeholder",children:"生成された業務フロー図がここに表示されます..."})]})]})}function i(){return(0,s.jsx)("div",{className:"code-section",id:"code-section",children:(0,s.jsxs)("div",{className:"panel",id:"code-panel",children:[(0,s.jsxs)("div",{className:"panel-header",children:[(0,s.jsxs)("span",{children:[(0,s.jsx)("i",{className:"fas fa-code"})," drawioコード"]}),(0,s.jsx)("span",{className:"panel-status",id:"code-status",children:"待機中"})]}),(0,s.jsxs)("div",{className:"panel-content",children:[(0,s.jsxs)("button",{className:"copy-code-btn",id:"copy-svg-btn",title:"drawioコードをコピー",children:[(0,s.jsx)("i",{className:"fas fa-copy"}),(0,s.jsx)("span",{children:"コピー"}),(0,s.jsx)("div",{className:"copy-tooltip",children:"drawioコードをコピーしました！"})]}),(0,s.jsx)("div",{id:"svg-code",className:"placeholder",children:"生成されたdrawioコードがここに段階的に表示されます..."})]})]})})}function r(){return(0,s.jsx)("div",{className:"panel-resizer",id:"left-panel-resizer",role:"separator","aria-label":"パネルリサイズ","aria-orientation":"horizontal",tabIndex:0,children:(0,s.jsxs)("div",{className:"resizer-grip","aria-hidden":"true",children:[(0,s.jsx)("span",{}),(0,s.jsx)("span",{}),(0,s.jsx)("span",{})]})})}function c(){return(0,s.jsx)("div",{id:"prompt-modal",className:"prompt-modal",children:(0,s.jsxs)("div",{className:"prompt-modal-content",children:[(0,s.jsxs)("div",{className:"prompt-modal-header",children:[(0,s.jsx)("h3",{className:"prompt-modal-title",children:"実際のプロンプト詳細"}),(0,s.jsx)("button",{className:"prompt-modal-close",id:"prompt-modal-close",children:(0,s.jsx)("i",{className:"fas fa-times"})})]}),(0,s.jsx)("div",{className:"prompt-modal-body",id:"prompt-modal-body"})]})})}var d=n(1266),h=n(4484);let p=!1,m=null;class g{getOrCreateSessionId(){let e="bitflow_session_id",t=localStorage.getItem(e);return t?console.log("既存のセッションIDを使用:",t):(t="session_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),localStorage.setItem(e,t),console.log("新しいセッションIDを生成しました:",t)),t}initializeElements(){this.elements={promptInput:document.getElementById("prompt-input"),generateBtn:document.getElementById("generate-btn"),clearBtn:document.getElementById("clear-btn"),chatMessages:document.getElementById("chat-messages"),svgCode:document.getElementById("svg-code"),flowDiagram:document.getElementById("flow-diagram"),btnText:document.getElementById("btn-text"),btnSpinner:document.getElementById("btn-spinner"),attachBtn:document.getElementById("attach-btn"),fileInput:document.getElementById("file-input"),attachmentList:document.getElementById("attachment-list"),chatStatus:document.getElementById("chat-status"),codeStatus:document.getElementById("code-status"),diagramStatus:document.getElementById("diagram-status"),copySvgBtn:document.getElementById("copy-svg-btn"),downloadSvgBtn:document.getElementById("download-svg-btn"),promptModal:document.getElementById("prompt-modal"),promptModalBody:document.getElementById("prompt-modal-body"),promptModalClose:document.getElementById("prompt-modal-close"),leftPanel:document.querySelector(".left-panel"),chatSection:document.getElementById("chat-section"),codeSection:document.getElementById("code-section"),panelResizer:document.getElementById("left-panel-resizer")},console.log("DOM要素取得結果:"),console.log("promptInput:",this.elements.promptInput),console.log("generateBtn:",this.elements.generateBtn),console.log("generateBtn disabled:",this.elements.generateBtn?this.elements.generateBtn.disabled:"undefined"),this.elements.attachmentList&&this.updateAttachmentListUI(),this.elements.generateBtn||console.error("送信ボタン (generate-btn) が見つかりません！"),this.elements.promptInput||console.error("プロンプト入力 (prompt-input) が見つかりません！")}getStoredPanelRatio(){let e=window.localStorage.getItem("bitflow_chat_ratio");if(!e)return .8;let t=parseFloat(e);return Number.isFinite(t)?Math.min(.9,Math.max(.2,t)):.8}persistPanelRatio(){try{window.localStorage.setItem("bitflow_chat_ratio",String(this.chatSectionRatio))}catch(e){console.warn("パネル比率の保存に失敗しました:",e)}}applyPanelSplit(e){if(!this.elements||!this.elements.chatSection||!this.elements.codeSection)return;let t=Math.min(.9,Math.max(.2,e));this.chatSectionRatio=t,this.elements.chatSection.style.flexGrow=String(t),this.elements.chatSection.style.flexShrink="1",this.elements.chatSection.style.flexBasis="0%",this.elements.codeSection.style.flexGrow=String(Math.max(.1,1-t)),this.elements.codeSection.style.flexShrink="1",this.elements.codeSection.style.flexBasis="0%"}setupPanelResizer(){if(!this.elements)return;let e=this.elements.panelResizer,t=this.elements.leftPanel;if(!e||!t||!this.elements.chatSection||!this.elements.codeSection)return;let n=!1,s=e=>{if(!t||"number"!=typeof e)return;let n=t.getBoundingClientRect();if(!n||n.height<=0)return;let s=(e-n.top)/n.height;this.applyPanelSplit(s),this.persistPanelRatio()},o=()=>{n&&(n=!1,document.body.classList.remove("is-resizing"))},l=e=>{n=!0,document.body.classList.add("is-resizing"),e.preventDefault(),s("touches"in e?e.touches[0]?e.touches[0].clientY:null:e.clientY)};e.addEventListener("mousedown",e=>l(e)),e.addEventListener("touchstart",e=>l(e),{passive:!1}),window.addEventListener("mousemove",e=>{n&&s(e.clientY)}),window.addEventListener("touchmove",e=>{if(!n)return;let t=e.touches[0];t&&(s(t.clientY),e.preventDefault())},{passive:!1}),window.addEventListener("mouseup",o),window.addEventListener("touchend",o),window.addEventListener("touchcancel",o),e.addEventListener("keydown",e=>{"ArrowUp"===e.key?(e.preventDefault(),this.applyPanelSplit(this.chatSectionRatio+.05),this.persistPanelRatio()):"ArrowDown"===e.key?(e.preventDefault(),this.applyPanelSplit(this.chatSectionRatio-.05),this.persistPanelRatio()):"Home"===e.key?(e.preventDefault(),this.applyPanelSplit(.9),this.persistPanelRatio()):"End"===e.key&&(e.preventDefault(),this.applyPanelSplit(.2),this.persistPanelRatio())})}attachEventListeners(){console.log("イベントリスナー設定開始"),this.elements.generateBtn?(this.elements.generateBtn.addEventListener("click",e=>{console.log("\uD83D\uDD35 Generate button clicked!"),console.log("\uD83D\uDD0D クリック時の状態:",{isGenerating:this.isGenerating,buttonDisabled:this.elements.generateBtn.disabled,inputValue:this.elements.promptInput?this.elements.promptInput.value:"N/A",hasInput:!!this.elements.promptInput&&this.elements.promptInput.value.trim().length>0}),e.preventDefault(),e.stopPropagation(),this.generateFlow()}),console.log("✅ Generate button イベントリスナー設定完了"),console.log("\uD83D\uDD0D 初期ボタン状態:",{exists:!0,disabled:this.elements.generateBtn.disabled,style:{display:window.getComputedStyle(this.elements.generateBtn).display,visibility:window.getComputedStyle(this.elements.generateBtn).visibility,pointerEvents:window.getComputedStyle(this.elements.generateBtn).pointerEvents}})):console.error("❌ Generate button が存在しないため、イベントリスナーを設定できません"),this.elements.clearBtn?this.elements.clearBtn.addEventListener("click",e=>{console.log("Clear button clicked"),e.preventDefault(),this.clearAll()}):console.error("Clear button が存在しません"),this.elements.attachBtn&&this.elements.fileInput?(this.elements.attachBtn.addEventListener("click",e=>{e.preventDefault(),this.elements.fileInput.click()}),this.elements.fileInput.addEventListener("change",async e=>{let t=e.target,n=Array.from(t.files||[]);n.length&&(console.log("\uD83D\uDCCE 添付ファイル選択:",n.map(e=>"".concat(e.name," (").concat(e.size," bytes)"))),await this.handleFileAttachments(n),t.value="")})):console.warn("添付ファイル入力要素が見つかりません"),this.elements.copySvgBtn?(this.elements.copySvgBtn.addEventListener("click",e=>{console.log("Copy drawio button clicked"),e.preventDefault(),this.copySvgCode()}),console.log("Copy drawio button イベントリスナー設定完了")):console.error("Copy drawio button が存在しません"),this.elements.downloadSvgBtn?(this.elements.downloadSvgBtn.addEventListener("click",e=>{console.log("Download drawio button clicked"),e.preventDefault(),this.downloadSvgFile()}),console.log("Download drawio button イベントリスナー設定完了")):console.error("Download drawio button が存在しません"),this.elements.promptModalClose&&this.elements.promptModalClose.addEventListener("click",()=>{this.closePromptModal()}),this.elements.promptModal&&(this.elements.promptModal.addEventListener("click",e=>{e.target===this.elements.promptModal&&this.closePromptModal()}),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.elements.promptModal.classList.contains("show")&&this.closePromptModal()})),this.elements.promptInput?(this.elements.promptInput.addEventListener("keydown",e=>{e.ctrlKey&&"Enter"===e.key&&!this.isGenerating&&(e.preventDefault(),this.generateFlow())}),this.elements.promptInput.addEventListener("input",e=>{console.log("\uD83D\uDCDD 入力イベント発生:",{value:e.target.value,length:e.target.value.length,trimmedLength:e.target.value.trim().length}),this.updateButtonState()}),console.log("✅ Prompt input イベントリスナー設定完了")):console.error("Prompt input が存在しないため、イベントリスナーを設定できません"),console.log("イベントリスナー設定完了")}updateButtonState(){if(!this.elements.generateBtn){console.error("updateButtonState: generateBtn が存在しません");return}if(!this.elements.promptInput){console.error("updateButtonState: promptInput が存在しません");return}let e=this.elements.promptInput.value,t=e.trim().length>0,n=this.attachments&&this.attachments.length>0,s=this.isGenerating||!t&&!n;this.elements.generateBtn.disabled=s,s?(this.elements.generateBtn.style.opacity="0.5",this.elements.generateBtn.style.cursor="not-allowed"):(this.elements.generateBtn.style.opacity="1",this.elements.generateBtn.style.cursor="pointer"),this.updateStatus("chat",t||n?"入力済み":"待機中"),console.log("\uD83D\uDD0D ボタン状態更新詳細:",{inputValue:e,hasContent:t,hasAttachments:n,isGenerating:this.isGenerating,shouldDisable:s,actualDisabled:this.elements.generateBtn.disabled,buttonExists:!!this.elements.generateBtn,inputExists:!!this.elements.promptInput})}updateStatus(e,t){let n=this.elements["".concat(e,"Status")];n&&(n.textContent=t)}generateAttachmentId(){let e="undefined"!=typeof globalThis?globalThis.crypto:void 0;return e&&"function"==typeof e.randomUUID?e.randomUUID():(this.attachmentIdCounter+=1,"attachment-".concat(Date.now(),"-").concat(this.attachmentIdCounter))}formatBytes(e){return e<1024?"".concat(e,"B"):e<1048576?"".concat((e/1024).toFixed(1),"KB"):"".concat((e/1048576).toFixed(1),"MB")}async handleFileAttachments(e){if(!e||0===e.length)return;let t=[];for(let n of e){if(n.size>2097152){this.showError("".concat(n.name," は最大サイズ（").concat(this.formatBytes(2097152),"）を超えています"));continue}try{let{content:e,encoding:s}=await (0,h.z1)(n);t.push({id:this.generateAttachmentId(),name:n.name,size:n.size,type:n.type||"unknown",encoding:s,content:e})}catch(t){console.error("ファイル読み込みエラー:",n.name,t);let e=t instanceof Error?t.message:"不明なエラー";this.showError("".concat(n.name," の読み込みに失敗しました: ").concat(e))}}t.length>0&&(this.attachments=this.attachments.concat(t),this.updateAttachmentListUI(),this.updateButtonState())}updateAttachmentListUI(){let e=this.elements.attachmentList;if(e){if(e.innerHTML="",!this.attachments||0===this.attachments.length){e.classList.add("empty");let t=document.createElement("span");t.className="attachment-placeholder",t.textContent="現在、添付ファイルはありません",e.appendChild(t);return}e.classList.remove("empty"),this.attachments.forEach(t=>{let n=document.createElement("div");n.className="attachment-item";let s=document.createElement("i");s.className="fas fa-file-alt",s.setAttribute("aria-hidden","true");let o=document.createElement("span");o.className="attachment-name",o.textContent=t.name,o.title=t.name;let l=document.createElement("span");l.className="attachment-meta",l.textContent="".concat(this.formatBytes(t.size)).concat("base64"===t.encoding?" / base64":"");let a=document.createElement("button");a.className="attachment-remove",a.type="button",a.innerHTML="&times;",a.setAttribute("aria-label","".concat(t.name," を削除")),a.addEventListener("click",()=>this.removeAttachment(t.id)),n.appendChild(s),n.appendChild(o),n.appendChild(l),n.appendChild(a),e.appendChild(n)})}}removeAttachment(e){this.attachments&&0!==this.attachments.length&&(this.attachments=this.attachments.filter(t=>t.id!==e),this.updateAttachmentListUI(),this.updateButtonState())}buildAttachmentSummary(e){return e&&0!==e.length?e.map((e,t)=>"#".concat(t+1,": ").concat(e.name," (").concat(this.formatBytes(e.size),")")).join("\n"):""}buildUserMessageDisplay(e,t){let n=(e||"").trim(),s=this.buildAttachmentSummary(t);return n&&s?"".concat(n,"\n\n--- 添付概要 ---\n").concat(s):!n&&s?"添付ファイル (".concat(t.length,"件)\n").concat(s):n||"（入力が空です）"}clearAttachments(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{skipButtonUpdate:t=!1}=e;this.attachments=[],this.updateAttachmentListUI(),this.elements.fileInput&&(this.elements.fileInput.value=""),t||this.updateButtonState()}updateConnectionStatus(e,t){console.log("接続状態: ".concat(e," - ").concat(t))}async checkConnection(){console.log("プロキシサーバー接続確認開始"),this.updateConnectionStatus("checking","接続確認中...");try{let e=await fetch(d.b.health,{method:"GET"});if(e.ok){let t=await e.json();return console.log("接続成功:",t),this.updateConnectionStatus("connected","サーバー接続OK"),!0}throw Error("HTTP ".concat(e.status))}catch(e){return console.error("接続失敗:",e),this.updateConnectionStatus("disconnected","サーバー接続失敗"),this.showError("プロキシサーバーに接続できません。サーバーが起動しているか確認してください。"),!1}}preparePrompt(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];console.log("プロンプト準備: セッションID",this.sessionId),console.log("ユーザープロンプト:",e),console.log("添付ファイル数:",t.length);let n=(e||"").trim();if(!t||0===t.length)return n;let s=t.map((e,t)=>{let n="【添付".concat(t+1,": ").concat(e.name," | ").concat(this.formatBytes(e.size)," | ").concat("text"===e.encoding?"text":"base64","】");return"".concat(n,"\n").concat(e.content)}).join("\n\n");return n?"".concat(n,"\n\n--- 添付ファイル詳細 ---\n").concat(s):"以下の添付ファイルをもとに業務フロー図を生成してください。\n\n--- 添付ファイル詳細 ---\n".concat(s)}async generateFlow(){if(console.log("\uD83D\uDE80 generateFlow() 呼び出し開始"),console.log("\uD83D\uDD0D 現在の状態詳細:",{isGenerating:this.isGenerating,generateBtnExists:!!this.elements.generateBtn,generateBtnDisabled:this.elements.generateBtn?this.elements.generateBtn.disabled:"N/A",promptInputExists:!!this.elements.promptInput,promptInputValue:this.elements.promptInput?this.elements.promptInput.value:"N/A",promptInputLength:this.elements.promptInput?this.elements.promptInput.value.length:"N/A"}),!this.elements.promptInput){console.error("promptInput が存在しません！"),this.showError("システムエラー: プロンプト入力が見つかりません");return}let e=(this.elements.promptInput.value||"").trim(),t=(this.attachments||[]).map(e=>({...e}));if(console.log("\uD83D\uDCDD ユーザープロンプト:",e),console.log("\uD83D\uDCCE 添付ファイル数:",t.length),!e&&0===t.length){console.log("⚠️ プロンプトと添付ファイルが空です"),this.showError("プロンプトまたは添付ファイルを入力してください。");return}if(this.isGenerating){console.log("⚠️ 既に生成中のため無視");return}console.log("フロー生成開始:",e);try{let n=this.buildUserMessageDisplay(e,t);if(this.addUserMessage(n),this.elements.promptInput.value="",this.clearAttachments({skipButtonUpdate:!0}),this.updateButtonState(),console.log("\uD83D\uDCDD 入力フォームをクリアしました"),this.startGenerating(),!await this.checkConnection())throw Error("プロキシサーバーに接続できません");let s=this.preparePrompt(e,t);console.log("送信プロンプト:",s),console.log("ストリーミング:",!0),await this.generateFlowStreaming(s)}catch(e){console.error("フロー生成エラー:",e),this.hideTypingIndicator(),this.showError("フロー生成エラー: ".concat(e.message))}finally{this.stopGenerating(),this.hideTypingIndicator()}}async generateFlowStreaming(e){console.log("ストリーミング生成開始"),this.updateStatus("response","ストリーミング中"),this.updateStatus("code","解析待機中"),this.updateStatus("diagram","描画待機中");try{let t=await fetch(d.b.messages(this.sessionId),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_prompt:e,streaming:!0,use_agent_mode:!0})});if(!t.ok){let e=await t.text();throw Error("HTTP ".concat(t.status,": ").concat(e))}this.currentStream=t,await this.handleStreamingResponse(t)}catch(e){throw console.error("ストリーミングエラー:",e),e}}sleep(e){return new Promise(t=>setTimeout(t,e))}async handleStreamingResponse(e){let t=e.body.getReader(),n=new TextDecoder,s="",o="";try{for(;;){let{done:e,value:l}=await t.read();if(e){console.log("ストリーミング完了");break}let a=(s+=n.decode(l,{stream:!0})).split("\n");for(let e of(s=a.pop()||"",a))if(""!==e.trim())try{let t=JSON.parse(e);if(console.log("ストリームデータ:",t),"start"===t.type){if(console.log("ストリーミング開始:",t.message),this.showTypingIndicator(),t.actualPrompt&&this.currentMessageId){let e=this.promptHistory.get(this.currentMessageId);e&&(e.actualPrompt=t.actualPrompt,console.log("実際のプロンプトを保存:",this.currentMessageId))}}else if("content"===t.type)o+=t.text,this.updateAssistantMessage(o),this.processStreamingSVG(t.text,o);else if("complete"===t.type)console.log("ストリーミング完了イベント受信:",t.totalChunks,"チャンク"),console.log("完了時のコンテンツ長:",t.fullContent?t.fullContent.length:"なし"),this.hideTypingIndicator(),this.updateStatus("chat","完了"),this.finalizeGeneration(t.fullContent||o);else if("error"===t.type)throw console.error("ストリーミングエラー:",t.error),this.hideTypingIndicator(),Error(t.error)}catch(t){console.warn("JSON解析エラー:",t,"Line:",e)}}}catch(e){throw console.error("ストリーミング処理エラー:",e),e}}async generateFlowBatch(e){console.log("バッチ生成開始"),this.updateStatus("chat","API呼び出し中"),this.showTypingIndicator();try{let t=await fetch(d.b.messagesBatch,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:e,sessionId:this.sessionId})});if(!t.ok){let e=await t.text();throw Error("HTTP ".concat(t.status,": ").concat(e))}let n=await t.json();if(console.log("バッチ生成完了:",n),n.actualPrompt&&this.currentMessageId){let e=this.promptHistory.get(this.currentMessageId);e&&(e.actualPrompt=n.actualPrompt,console.log("実際のプロンプトを保存（バッチ）:",this.currentMessageId))}this.hideTypingIndicator(),this.updateAssistantMessage(n.content),this.updateStatus("chat","完了"),this.finalizeGeneration(n.content)}catch(e){throw console.error("バッチ生成エラー:",e),e}}processStreamingSVG(e,t){if(!this.svgStarted&&(e.includes("<?xml")||e.includes("<mxfile"))&&(console.log("drawioコード開始を検出"),this.svgStarted=!0,this.accumulatedSvgCode="",this.updateStatus("code","drawio生成中")),this.svgStarted&&(this.accumulatedSvgCode+=e,this.displaySVGCode(this.accumulatedSvgCode),this.forceScroll(this.elements.svgCode),this.forceUpdateFlowDiagram(this.accumulatedSvgCode),this.accumulatedSvgCode.includes("</mxfile>"))){console.log("drawioコード完了を検出"),this.updateStatus("code","drawio完了");let e=this.accumulatedSvgCode.match(/<\?xml[\s\S]*?<\/mxfile>|<mxfile[\s\S]*?<\/mxfile>/);e&&this.updateFlowDiagram(e[0])}}displaySVGCode(e){try{console.log("displayDrawioCode - 入力drawioコードの最初の100文字:",e.substring(0,100));let t=this.formatSVGCode(e);console.log("formatDrawioCode後の最初の100文字:",t.substring(0,100));let n=t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");n=(n=(n=n.replace(/(&lt;!--[\s\S]*?--&gt;)/g,'<span class="svg-comment">$1</span>')).replace(/(&lt;\?xml[\s\S]*?\?&gt;)/g,'<span class="svg-tag">$1</span>')).replace(/(&lt;\/?)([a-zA-Z][\w\-:]*)((?:\s+[\w\-:]+(?:=&quot;[^&]*&quot;)?)*\s*)(\/?)(&gt;)/g,function(e,t,n,s,o,l){let a='<span class="svg-tag">'+t+n+"</span>";return s&&(a+=s.replace(/(\s+)([\w\-:]+)(=)(&quot;)([^&]*)(&quot;)/g,'$1<span class="svg-attribute">$2</span>$3$4<span class="svg-value">$5</span>$6')),a+='<span class="svg-tag">'+o+l+"</span>"}),this.elements.svgCode.innerHTML=n,this.elements.svgCode.classList.remove("placeholder")}catch(t){console.warn("シンタックスハイライトエラー:",t),this.elements.svgCode.textContent=e,this.elements.svgCode.classList.remove("placeholder")}}formatSVGCode(e){try{let t=e.replace(/>\s*</g,">\n<").split("\n"),n=0,s=[];for(let e of t){let t=e.trim();if(!t)continue;let o=t.startsWith("</"),l=t.startsWith("<?"),a=t.startsWith("<!--"),i=t.endsWith("/>"),r=!t.startsWith("<");o&&(n=Math.max(0,n-1));let c="";l||(c=" ".repeat(2*n)),s.push(c+t),!(!o&&!l&&!a&&!i&&!r&&t.startsWith("<"))||t.includes("><")||t.match(/<[^>]+>[^<]+<\/[^>]+>/)||n++}let o=s.join("\n");return console.log("\uD83C\uDFA8 drawioフォーマット完了:",{originalLines:t.length,formattedLines:s.length,maxIndent:Math.max(...s.map(e=>e.match(/^ */)[0].length/2))}),o}catch(t){return console.warn("drawioフォーマットエラー:",t),e}}forceUpdateFlowDiagram(e){try{if(e.length<200){console.log("svgCode.length < 200");return}if(!e.includes("<mxfile")&&!e.includes("<mxGraphModel")){console.log("!svgCode.includes('<mxfile') && !svgCode.includes('<mxGraphModel')");return}if(this.updateTimer)return;this.updateTimer=setTimeout(()=>{this._doForceUpdateFlowDiagram(e),this.updateTimer=null},10)}catch(e){console.debug("フロー図更新スキップ:",e.message)}}_doForceUpdateFlowDiagram(e){if(console.log("リアルタイム描画実行:",e.length,"文字"),"undefined"==typeof mxGraph){console.error("MXGraphライブラリが読み込まれていません");return}let t=e,n=t.indexOf("<?xml");-1===n?t='<?xml version="1.0" encoding="UTF-8"?>\n'+t:n>0&&(t=t.slice(n));let s=t.lastIndexOf("</mxCell>");-1!==s&&(t=t.slice(0,s+9)),["</root>","</mxGraphModel>","</diagram>","</mxfile>"].forEach(e=>{t.includes(e)||(t+=e)});try{console.log("MXGraphコンテナを新規作成"),this.elements.flowDiagram.innerHTML='<div id="mxgraph-container" style="width: 100%; height: 100%; min-height: 600px; background: white; overflow: auto;"></div>';let e=document.getElementById("mxgraph-container");if(!e){console.error("コンテナが見つかりません");return}try{let n=new mxGraph(e);n.setEnabled(!1),this.setupGraphStyles(n);let s=e=>e?e.replace(/&(?!amp;|lt;|gt;|quot;|#x[0-9a-fA-F]+;|#[0-9]+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;"):e,o=t;o=o.replace(/(\w+)="([^"]*)"/g,(e,t,n)=>{if(n.includes("&lt;")||n.includes("&gt;")||n.includes("&amp;")||n.includes("&quot;"))return e;if(n.includes("<")||n.includes(">")||n.includes("&")||n.includes('"')){let e=s(n);return"".concat(t,'="').concat(e,'"')}return e});let l=new DOMParser().parseFromString(o,"text/xml"),a=new mxCodec,i=l.querySelector("mxGraphModel");i&&(a.decode(i,n.getModel()),this.fixGraphStyles(n));try{e.style.visibility="hidden",n.fit();let t=n.getGraphBounds();if(t){let s=Math.min(t.width+40,this.elements.flowDiagram.clientWidth-10),o=Math.max(t.height+40,400);requestAnimationFrame(()=>{e.style.width="".concat(s,"px"),e.style.height="".concat(o,"px"),e.style.overflow="hidden",n.sizeDidChange(),this.alignGraphToTop(n),e.style.visibility="visible"})}else e.style.visibility="visible"}catch(t){console.log("リアルタイムフィットエラー:",t.message),e.style.visibility="visible"}n.refresh(),console.log("リアルタイム描画成功"),this.updateStatus("diagram","描画中"),this.elements.flowDiagram.classList.remove("svg-processing"),this.elements.flowDiagram.classList.add("svg-ready")}catch(e){console.debug("描画エラー:",e.message)}}catch(e){console.error("リアルタイム描画エラー:",e)}}initializeRealtimeGraph(){if(!this.elements.flowDiagram){console.error("フロー図要素が見つかりません");return}if("undefined"==typeof mxGraph){console.error("MXGraphライブラリが利用できません");return}this.elements.flowDiagram.classList.add("svg-processing"),this.elements.flowDiagram.classList.remove("svg-ready"),this.elements.flowDiagram.innerHTML='<div id="mxgraph-container" style="width: 100%; height: 100%; background: white; overflow: auto;"></div>';let e=document.getElementById("mxgraph-container");if(!e){console.error("MXGraphコンテナの作成に失敗しました");return}try{this.currentGraph=new mxGraph(e),this.currentGraph.setEnabled(!1),this.setupGraphStyles(this.currentGraph),this.vertexMap=new Map,this.pendingEdges=[],console.log("リアルタイムグラフ初期化完了")}catch(e){throw console.error("グラフ初期化エラー:",e),e}}setupGraphStyles(e){if(!e||!e.getStylesheet){console.error("グラフオブジェクトが無効です");return}if("undefined"==typeof mxConstants){console.warn("mxConstantsが利用できません。基本的なスタイル設定をスキップします");return}"undefined"==typeof mxCellRenderer&&console.warn("mxCellRendererが利用できません。カスタムシェイプ登録をスキップします");try{let t=e.getStylesheet(),n=t.getDefaultVertexStyle();n[mxConstants.STYLE_FONTCOLOR]="#000000",n[mxConstants.STYLE_FONTFAMILY]="Helvetica, Arial, sans-serif",n[mxConstants.STYLE_FONTSIZE]="12",n[mxConstants.STYLE_STROKECOLOR]="#000000",n[mxConstants.STYLE_STROKEWIDTH]="1";let s=t.getDefaultEdgeStyle();s[mxConstants.STYLE_STROKECOLOR]="#000000",s[mxConstants.STYLE_STROKEWIDTH]="1",s[mxConstants.STYLE_ENDARROW]=mxConstants.ARROW_CLASSIC,"undefined"!=typeof mxCellRenderer&&this.registerDrawioCompatibleShapes(),console.log("Draw.io互換スタイルの設定完了")}catch(e){console.error("スタイル設定エラー:",e)}}registerDrawioCompatibleShapes(){try{"undefined"!=typeof mxSwimlane?(mxCellRenderer.registerShape("swimlane",mxSwimlane),console.log("swimlaneシェイプを登録しました")):console.warn("mxSwimlaneが利用できません"),"undefined"!=typeof mxRectangleShape&&(mxCellRenderer.registerShape("group",mxRectangleShape),console.log("groupシェイプを登録しました")),"undefined"!=typeof mxRhombus&&(mxCellRenderer.registerShape("rhombus",mxRhombus),console.log("rhombusシェイプを登録しました")),"undefined"!=typeof mxEllipse&&(mxCellRenderer.registerShape("ellipse",mxEllipse),console.log("ellipseシェイプを登録しました")),"undefined"!=typeof mxCylinder&&(mxCellRenderer.registerShape("cylinder3",mxCylinder),mxCellRenderer.registerShape("cylinder",mxCylinder),console.log("cylinder/cylinder3シェイプを登録しました"));let e=function(){if(m||"undefined"==typeof mxShape||"undefined"==typeof mxUtils)return m;let e=function(){mxShape.call(this)};return mxUtils.extend(e,mxShape),e.prototype.paintBackground=function(e,t,n,s,o){let l=Math.min(.2*s,.2*o,20);e.begin(),e.moveTo(t,n),e.lineTo(t+s-l,n),e.lineTo(t+s,n+l),e.lineTo(t+s,n+o),e.lineTo(t,n+o),e.close(),e.fillAndStroke(),e.begin(),e.moveTo(t+s-l,n),e.lineTo(t+s-l,n+l),e.lineTo(t+s,n+l),e.stroke()},m=e}();e&&(mxCellRenderer.registerShape("document",e),console.log("documentシェイプを登録しました")),"undefined"!=typeof mxRectangleShape&&mxCellRenderer.registerShape("note",mxRectangleShape),"undefined"!=typeof mxRectangleShape&&mxCellRenderer.registerShape("rounded",mxRectangleShape)}catch(e){console.error("カスタムシェイプ登録エラー:",e)}}fixGraphStyles(e){if(!e||!e.getModel){console.error("グラフオブジェクトが無効です");return}let t=e.getModel(),n=t.cells;t.beginUpdate();try{for(let e in n){let t=n[e];if(!t||!t.style)continue;let s=t.style;s=this.mapDrawioShapes(s);let o=this.parseStyleString(s);this.adjustDrawioCompatibleStyle(o,t);let l=this.rebuildStyleString(o);"function"==typeof t.setStyle?t.setStyle(l):t.style=l}}finally{t.endUpdate()}e.refresh()}alignGraphToTop(e){if(e&&e.view)try{"function"==typeof e.center&&e.center(!0,!1);let t=e.view;if(!t)return;let n=t.translate?t.translate.x:0;"function"==typeof t.setTranslate?t.setTranslate(n,0):t.translate&&(t.translate.x=n,t.translate.y=0)}catch(e){console.warn("グラフの上揃えに失敗:",e)}}mapDrawioShapes(e){return e.includes("rhombus")&&console.log("ひし形シェイプを検出:",e),e.includes("ellipse")&&console.log("楕円シェイプを検出:",e),e.includes("document")&&console.log("ドキュメントシェイプを検出:",e),e=(e=(e=e.replace(/shape=cylinder3/g,"shape=cylinder")).replace(/shape=process/g,"shape=rectangle")).replace(/shape=rhombus/g,"shape=rhombus")}parseStyleString(e){let t={};return e.split(";").forEach(e=>{let[n,s]=e.split("=");n&&s&&(t[n.trim()]=s.trim())}),t}adjustDrawioCompatibleStyle(e,t){e.fontFamily||(e.fontFamily="Helvetica"),e.fontSize||(e.fontSize="12"),"ellipse"!==e.shape&&"cylinder"!==e.shape||"#2196F3"!==e.fillColor||e.fontColor||(e.fontColor="#ffffff"),e.fontColor||(e.fontColor="#000000"),e.strokeWidth||(e.strokeWidth="1"),e.strokeColor||"ellipse"===e.shape||(e.strokeColor="#000000"),"ellipse"===e.shape&&(e.aspect="fixed"),"cylinder"!==e.shape||e.size||(e.size="15"),"rhombus"===e.shape&&(e.perimeter="rhombusPerimeter"),"rectangle"!==e.shape||e.rounded||"#f5faff"!==e.fillColor&&"#ffffff"!==e.fillColor||(e.rounded="1",e.arcSize="10"),e.align||(e.align="center"),e.verticalAlign||(e.verticalAlign="middle")}rebuildStyleString(e){return Object.entries(e).filter(e=>{let[t,n]=e;return t&&n}).map(e=>{let[t,n]=e;return"".concat(t,"=").concat(n)}).join(";")}addNewElementsToGraph(e){if(this.currentGraph)try{let t=e=>e?e.replace(/&(?!amp;|lt;|gt;|quot;|#x[0-9a-fA-F]+;|#[0-9]+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;"):e,n=e;n=n.replace(/(\w+)="([^"]*)"/g,(e,n,s)=>{if(s.includes("&lt;")||s.includes("&gt;")||s.includes("&amp;")||s.includes("&quot;"))return e;if(s.includes("<")||s.includes(">")||s.includes("&")||s.includes('"')){let e=t(s);return"".concat(n,'="').concat(e,'"')}return e});let s=new DOMParser().parseFromString(n,"text/xml").querySelectorAll("mxCell"),o=this.currentGraph.getModel(),l=this.currentGraph.getDefaultParent();o.beginUpdate();try{s.forEach(e=>{let t=e.getAttribute("id");if(!t||this.parsedCells.has(t)||"1"!==e.getAttribute("vertex"))return;this.parsedCells.add(t);let n=e.getAttribute("value")||"",s=e.getAttribute("style")||"",o=e.querySelector("mxGeometry");if(o){let e=parseFloat(o.getAttribute("x")||"0"),a=parseFloat(o.getAttribute("y")||"0"),i=parseFloat(o.getAttribute("width")||"100"),r=parseFloat(o.getAttribute("height")||"40");try{let o=this.currentGraph.insertVertex(l,t,n,e,a,i,r,this.determineStyleFromDrawio(s));this.vertexMap.set(t,o),console.log("頂点追加:",t,n)}catch(e){console.debug("頂点追加エラー:",e)}}}),s.forEach(e=>{let t=e.getAttribute("id");if(!t||this.parsedCells.has(t)||"1"!==e.getAttribute("edge"))return;this.parsedCells.add(t);let n=e.getAttribute("value")||"",s=e.getAttribute("style")||"",o=e.getAttribute("source"),l=e.getAttribute("target");this.tryAddEdge(t,n,s,o,l,e)}),this.processPendingEdges()}finally{o.endUpdate()}this.currentGraph.refresh(),!this.svgDisplayed&&this.parsedCells.size>0&&requestAnimationFrame(()=>{this.elements.flowDiagram.classList.remove("svg-processing"),this.elements.flowDiagram.classList.add("svg-ready"),this.svgDisplayed=!0})}catch(e){console.debug("要素追加エラー:",e)}}determineStyleFromDrawio(e){return e.includes("ellipse")||e.includes("shape=ellipse")?"startEnd":e.includes("rhombus")||e.includes("shape=rhombus")?"decision":e.includes("cylinder")||e.includes("shape=cylinder3")?"database":e.includes("document")||e.includes("shape=document")?"document":(e.includes("rounded=1"),"task")}tryAddEdge(e,t,n,s,o,l){let a=this.vertexMap.get(s),i=this.vertexMap.get(o);if(a&&i)try{let r=this.currentGraph.getDefaultParent(),c=this.determineEdgeStyle(n),d=l.querySelector("mxGeometry"),h=[];d&&d.querySelectorAll("mxPoint").forEach(e=>{let t=parseFloat(e.getAttribute("x")||"0"),n=parseFloat(e.getAttribute("y")||"0");h.push(new mxPoint(t,n))});let p=this.currentGraph.insertEdge(r,e,t,a,i,c);h.length>0&&p.geometry&&(p.geometry.points=h),console.log("エッジ追加:",e,s,"->",o)}catch(e){console.debug("エッジ追加エラー:",e)}else this.pendingEdges.push({cellId:e,value:t,style:n,sourceId:s,targetId:o,cellElement:l})}processPendingEdges(){let e=[];this.pendingEdges.forEach(t=>{let n=this.vertexMap.get(t.sourceId),s=this.vertexMap.get(t.targetId);n&&s?this.tryAddEdge(t.cellId,t.value,t.style,t.sourceId,t.targetId,t.cellElement):e.push(t)}),this.pendingEdges=e}determineEdgeStyle(e){let t="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;";return e.includes("#1E88E5")?t+="strokeColor=#1E88E5;":t+="strokeColor=#333333;",t+="strokeWidth=1.5;endArrow=classic;endFill=1;"}showPartialDrawioAsText(e){console.log("部分的なdrawioコード:",e.length,"文字")}showMXGraphError(e,t){console.error("MXGraphエラー表示:",t.message),this.elements.flowDiagram.innerHTML='<div id="mxgraph-container" style="width: 100%; height: 400px; background: white; overflow: auto;"></div>';let n=document.getElementById("mxgraph-container");if(n&&"undefined"!=typeof mxGraph)try{let e=new mxGraph(n);e.setEnabled(!1),this.setupGraphStyles(e);let s=e.getDefaultParent();e.getModel().beginUpdate();try{e.insertVertex(s,null,"MXGraphエラー: "+t.message,20,20,300,60,"fillColor=#ffcccc;strokeColor=#cc0000;fontColor=#cc0000")}finally{e.getModel().endUpdate()}}catch(e){console.error("エラー表示も失敗:",e)}}loadMXGraphAndRetry(e){console.log("MXGraphライブラリの再読み込みを試行");let t=document.createElement("script");t.type="text/javascript",t.src="https://jgraph.github.io/mxgraph/javascript/mxClient.js",t.onload=()=>{console.log("MXGraphライブラリ再読み込み完了"),this.updateFlowDiagram(e)},t.onerror=()=>{console.error("MXGraphライブラリの読み込みに失敗"),this.showDrawioAsText(e)},document.head.appendChild(t)}extractAndUpdateSVG(e){console.log("drawio抽出開始, コンテンツ長:",e?e.length:0);let t=e.match(/<\?xml[\s\S]*?<\/mxfile>|<mxfile[\s\S]*?<\/mxfile>/);if(t){let e=t[0];console.log("drawio抽出成功, drawio長:",e.length),this.accumulatedSvgCode=e,console.log("accumulatedSvgCodeに保存しました"),this.displaySVGCode(e),this.forceScroll(this.elements.svgCode),this.updateStatus("code","drawio抽出済み"),console.log("===== フロー図更新を呼び出し ====="),console.log("SVGコードの最初の500文字:",e.substring(0,500)),this.updateFlowDiagram(e)}else{console.warn("drawioコードが見つかりませんでした"),console.log("レスポンス内容の最初の500文字:",e.substring(0,500)),console.log("レスポンス内容の最後の500文字:",e.substring(e.length-500));let t=e.match(/<mxfile[\s\S]*?<\/mxfile>/);if(t){console.log("代替パターンでdrawioコードを発見！");let e=t[0];this.accumulatedSvgCode=e,this.displaySVGCode(e),this.updateFlowDiagram(e);return}this.updateStatus("code","drawioなし"),this.updateStatus("diagram","drawioなし"),this.showError("drawioコードが生成されませんでした。プロンプトを確認してください。")}}testBasicMXGraph(){console.log("=== MXGraph基本テスト開始 ===");try{if(console.log("mxGraph定義:","undefined"!=typeof mxGraph),console.log("mxUtils定義:","undefined"!=typeof mxUtils),console.log("mxConstants定義:","undefined"!=typeof mxConstants),console.log("mxCellRenderer定義:","undefined"!=typeof mxCellRenderer),"undefined"==typeof mxGraph)return console.error("MXGraphライブラリが読み込まれていません"),!1;this.elements.flowDiagram.innerHTML='<div id="test-container" style="width: 100%; height: 500px; background: #f0f0f0;"></div>';let e=document.getElementById("test-container");if(!e)return console.error("テストコンテナの作成に失敗"),!1;let t=new mxGraph(e);t.setEnabled(!1);let n=t.getDefaultParent();t.getModel().beginUpdate();try{let e=t.insertVertex(n,null,"テスト開始",20,20,80,30,"fillColor=#2196F3;strokeColor=#0D47A1;fontColor=#ffffff;shape=ellipse"),s=t.insertVertex(n,null,"タスク1",150,20,100,40,"fillColor=#f5faff;strokeColor=#2196F3;fontColor=#000000"),o=t.insertVertex(n,null,"DB",300,20,80,60,"shape=cylinder;fillColor=#2196F3;strokeColor=#0D47A1;fontColor=#ffffff");t.insertEdge(n,null,"",e,s),t.insertEdge(n,null,"",s,o),console.log("テスト要素の追加成功")}finally{t.getModel().endUpdate()}let s=e.querySelector("svg");return s?(console.log("SVG要素が作成されました"),console.log("SVGサイズ:",s.getAttribute("width"),"x",s.getAttribute("height"))):console.error("SVG要素が作成されていません"),console.log("=== MXGraph基本テスト完了 ==="),!0}catch(e){return console.error("MXGraph基本テストエラー:",e),console.error("エラースタック:",e.stack),!1}}updateFlowDiagram(e){console.log("=== updateFlowDiagram開始 ==="),console.log("drawioコード長:",e?e.length:0),console.log("最初の200文字:",e?e.substring(0,200):"null"),console.log("mxGraph利用可能:","undefined"!=typeof mxGraph),console.log("flowDiagram要素:",this.elements.flowDiagram),console.log("フロー図エリアの子要素数:",this.elements.flowDiagram.children.length),console.log("フロー図エリアのinnerHTML長:",this.elements.flowDiagram.innerHTML.length),console.log("drawio描画を開始..."),this._performActualDrawing(e)}_performActualDrawing(e){console.log("=== 実際のdrawio描画開始 ===");try{let t=e=>e?e.replace(/&(?!amp;|lt;|gt;|quot;|#x[0-9a-fA-F]+;|#[0-9]+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;"):e,n=e;n=n.replace(/(\w+)="([^"]*)"/g,(e,n,s)=>{if(s.includes("&lt;")||s.includes("&gt;")||s.includes("&amp;")||s.includes("&quot;"))return e;if(s.includes("<")||s.includes(">")||s.includes("&")||s.includes('"')){let e=t(s);return"".concat(n,'="').concat(e,'"')}return e});let s=new DOMParser().parseFromString(n,"text/xml"),o=s.querySelector("parsererror");if(o){console.error("XMLパースエラー:",o.textContent);return}console.log("XML解析成功"),this.elements.flowDiagram.classList.add("svg-processing"),this.elements.flowDiagram.classList.remove("svg-ready"),console.log("MXGraphコンテナ作成中..."),console.log("フロー図エリアのサイズ:",this.elements.flowDiagram.offsetWidth,"x",this.elements.flowDiagram.offsetHeight),this.elements.flowDiagram.innerHTML='<div id="mxgraph-container" style="width: 100%; height: 100%; min-height: 600px; background: white; overflow: auto; position: relative;"></div>';let l=document.getElementById("mxgraph-container");if(!l){console.error("コンテナの作成に失敗しました");return}if(console.log("コンテナ作成成功"),console.log("mxGraph利用可能（内部）:","undefined"!=typeof mxGraph),"undefined"!=typeof mxGraph){console.log("MXGraphの初期化を開始します");try{let e=new mxGraph(l);e.setEnabled(!1),e.setBackgroundImage(null);let t=e.getView().getBackgroundPane();t&&(t.style.backgroundColor="#ffffff"),this.setupGraphStyles(e),console.log("drawio XMLデコード開始"),console.log("doc.documentElement:",s.documentElement),console.log("doc.documentElement.tagName:",s.documentElement.tagName);let n=new mxCodec,o=s.documentElement.querySelector("diagram");if(console.log("diagramNode存在:",!!o),console.log("doc全体（最初の500文字）:",new XMLSerializer().serializeToString(s).substring(0,500)),o){console.log("diagramコンテンツ長:",o.textContent?o.textContent.length:0);let t=o.querySelector("mxGraphModel");if(t){console.log("diagram内に直接mxGraphModelを発見。圧縮されていないdrawioファイルです。"),console.log("innerGraphModel:",t),console.log("innerGraphModel children数:",t.children.length);try{n.decode(t,e.getModel()),console.log("直接デコード完了");let s=Object.keys(e.getModel().cells).length;console.log("デコード後のセル数:",s)}catch(e){console.error("デコードエラー:",e)}}else try{let t;let s=o.textContent||o.innerHTML;if(console.log("圧縮データをデコード中..."),"function"==typeof e.decompress)t=e.decompress(s);else if("undefined"!=typeof mxUtils&&"function"==typeof mxUtils.decompress)t=mxUtils.decompress(s);else{console.log("デコンプレス機能が利用できません。Base64デコードを試行...");try{t=atob(s)}catch(e){console.log("Base64デコードも失敗、生データを使用"),t=s}}if(console.log("デコード成功、XML解析中..."),"undefined"!=typeof mxUtils&&"function"==typeof mxUtils.parseXml){let s=mxUtils.parseXml(t);n.decode(s.documentElement,e.getModel())}else{let s=new DOMParser().parseFromString(t,"text/xml").querySelector("mxGraphModel");s&&n.decode(s,e.getModel())}console.log("グラフモデルへのデコード完了")}catch(o){console.log("圧縮デコードエラー:",o.message);let t=s.querySelector("mxGraphModel");console.log("mxGraphModel存在:",!!t),t?(console.log("直接デコード実行"),n.decode(t,e.getModel()),console.log("直接デコード完了")):console.error("mxGraphModel要素が見つかりません")}}else{let t=s.querySelector("mxGraphModel");console.log("mxGraphModel存在（直接）:",!!t),t&&(console.log("直接デコード実行（diagramなし）"),n.decode(t,e.getModel()),console.log("直接デコード完了（diagramなし）"))}console.log("スタイル修正前のセル数:",Object.keys(e.getModel().cells).length);let a={},i=e.getModel().cells,r=0,c=0;for(let e in i){let t=i[e];if(t&&t.style){let n=t.style.match(/shape=(\w+)/);if(n){let s=n[1];a[s]=(a[s]||0)+1,"document"===s&&console.log("Document shape found: id=".concat(e,", value=").concat(t.value,", geometry="),t.geometry)}t.style.includes("swimlane")&&(r++,console.log("Swimlane found: id=".concat(e,", value=").concat(t.value,", parent=").concat(t.parent?t.parent.id:"none"))),t.style.includes("group")&&(c++,console.log("Group found: id=".concat(e,", value=").concat(t.value)))}}console.log("検出されたシェイプ:",a),console.log("スイムレーン数: ".concat(r,", グループ数: ").concat(c));try{this.fixGraphStyles(e),console.log("スタイル修正完了")}catch(e){console.error("スタイル修正エラー:",e),console.log("スタイル修正をスキップして続行")}console.log("グラフの位置調整中（上揃え）..."),l.style.visibility="hidden";try{e.fit(),console.log("graph.fit()実行完了");let t=e.getGraphBounds();if(t){let n=Math.min(t.width+40,this.elements.flowDiagram.clientWidth-10),s=Math.max(t.height+40,400);console.log("コンテンツサイズ: ".concat(n,"x").concat(s)),requestAnimationFrame(()=>{l.style.width="".concat(n,"px"),l.style.height="".concat(s,"px"),l.style.overflow="hidden",e.sizeDidChange(),this.alignGraphToTop(e),l.style.visibility="visible"})}else l.style.visibility="visible"}catch(t){console.log("フィットエラー:",t.message),this.alignGraphToTop(e),l.style.visibility="visible",console.log("フォールバック上揃え配置完了")}let d=0,h=0,p=[];for(let e in i){let t=i[e];if(t&&t.vertex){d++;let e=t.geometry;e&&p.push({id:t.id,value:t.value,x:e.x,y:e.y,width:e.width,height:e.height})}t&&t.edge&&h++}if(console.log("グラフ内容: 頂点数=".concat(d,", エッジ数=").concat(h)),console.log("最初の5つの要素の位置:",p.slice(0,5)),0===d&&0===h){console.error("警告: グラフに要素が1つもありません！");let t=e.getDefaultParent();e.getModel().beginUpdate();try{e.insertVertex(t,null,"デコードエラー: フロー図が表示されません",20,20,300,60,"fillColor=#ffcccc;strokeColor=#cc0000;fontColor=#cc0000")}finally{e.getModel().endUpdate()}}if(l){let e=l.getBoundingClientRect();console.log("コンテナサイズ: width=".concat(e.width,", height=").concat(e.height)),console.log("コンテナ表示状態: display=".concat(window.getComputedStyle(l).display))}let m=e.getView(),g=m.getScale(),u=m.getTranslate();console.log("グラフビュー: scale=".concat(g,", translate=(").concat(u.x,", ").concat(u.y,")")),console.log("強制再描画を実行中..."),e.refresh(),e.sizeDidChange();let f=l.querySelector("svg");if(f){console.log("SVG要素が見つかりました"),console.log("SVGサイズ: width=".concat(f.getAttribute("width"),", height=").concat(f.getAttribute("height")));let e=f.querySelectorAll("g");console.log("g要素の数: ".concat(e.length)),f.style.display="block",f.style.visibility="visible",f.style.opacity="1",f.style.position="relative",f.style.zIndex="1",l.style.display="block",l.style.visibility="visible",l.style.opacity="1";let t=f.querySelectorAll("path, text, rect, ellipse, polygon");console.log("SVG内の描画要素数: ".concat(t.length)),t.forEach((e,t)=>{t<5&&console.log("要素".concat(t,": ").concat(e.tagName,", style: ").concat(e.getAttribute("style")))})}else{console.error("SVG要素が見つかりません"),console.log("コンテナの子要素数:",l.children.length);for(let e=0;e<l.children.length;e++)console.log("子要素".concat(e,": ").concat(l.children[e].tagName,", class: ").concat(l.children[e].className))}requestAnimationFrame(()=>{this.elements.flowDiagram.classList.remove("svg-processing"),this.elements.flowDiagram.classList.add("svg-ready"),console.log("表示状態更新完了");let e=window.getComputedStyle(this.elements.flowDiagram);console.log("フロー図エリアの表示状態:"),console.log("  display:",e.display),console.log("  visibility:",e.visibility),console.log("  opacity:",e.opacity),console.log("  height:",e.height)}),this.updateStatus("diagram","描画完了"),console.log("=== MXGraphレンダリング完了 ===")}catch(t){console.error("MXGraphレンダリングエラー:",t),console.error("エラースタック:",t.stack),this.showMXGraphError(e,t)}}else console.warn("MXGraphライブラリが読み込まれていません"),this.loadMXGraphAndRetry(e)}catch(e){console.error("フロー図更新エラー:",e),this.updateStatus("diagram","エラー"),this.elements.flowDiagram.classList.remove("svg-processing"),this.elements.flowDiagram.classList.add("svg-ready")}}showDrawioAsText(e){this.elements.flowDiagram.innerHTML='\n            <div style="padding: 20px; font-family: monospace; font-size: 12px; overflow: auto; background: #f5f5f5; border-radius: 4px;">\n                <p style="margin-bottom: 10px; color: #666;">drawioコードが生成されました。draw.ioで開くか、ダウンロードしてください。</p>\n                <pre style="white-space: pre-wrap; word-wrap: break-word;">'.concat(this.escapeHtml(e),"</pre>\n            </div>\n        "),requestAnimationFrame(()=>{this.elements.flowDiagram.classList.remove("svg-processing"),this.elements.flowDiagram.classList.add("svg-ready")}),this.updateStatus("diagram","テキスト表示")}autoFitSVG(e){try{let t=this.elements.flowDiagram.getBoundingClientRect(),n=t.width-20,s=t.height-20;if(console.log("drawioフルサイズ表示: container ".concat(n,"x").concat(s)),!e.getAttribute("viewBox")){let t=e.getAttribute("width")||800,n=e.getAttribute("height")||600;e.setAttribute("viewBox","0 0 ".concat(t," ").concat(n))}e.setAttribute("preserveAspectRatio","xMidYMid meet"),e.removeAttribute("width"),e.removeAttribute("height"),Object.assign(e.style,{width:"100%",height:"100%",maxWidth:"100%",maxHeight:"100%",display:"block",margin:"0",objectFit:"contain"})}catch(t){console.error("drawioフィットエラー:",t),e.style.width="100%",e.style.height="100%"}}forceScroll(e){try{e.scrollTop=e.scrollHeight,setTimeout(()=>{e.scrollTop=e.scrollHeight},0),setTimeout(()=>{e.scrollTop=e.scrollHeight},50)}catch(e){console.warn("強制スクロールエラー:",e)}}autoScroll(e){this.forceScroll(e)}finalizeGeneration(e){console.log("生成処理最終化"),this.hideTypingIndicator(),this.extractAndUpdateSVG(e),e.match(/<\?xml[\s\S]*?<\/mxfile>|<mxfile[\s\S]*?<\/mxfile>/)&&this.showSuccess("フロー生成が完了しました！"),this.stopGenerating()}startGenerating(){console.log("生成状態開始"),this.isGenerating=!0,this.svgStarted=!1,this.accumulatedSvgCode="",this.svgDisplayed=!1,this.lastDisplayedSvgLength=0,this.elements.flowDiagram.innerHTML="",this.elements.generateBtn.disabled=!0,this.elements.btnText.style.display="none",this.elements.btnSpinner.style.display="block",this.clearResults(),this.updateStatus("chat","処理中")}stopGenerating(){console.log("生成状態終了"),this.isGenerating=!1,this.elements.btnText.style.display="block",this.elements.btnSpinner.style.display="none",this.updateStatus("chat","完了"),this.updateStatus("diagram","描画完了"),this.updateButtonState(),this.currentStream&&(this.currentStream=null)}addUserMessage(e){if(!this.elements.chatMessages){console.error("chatMessages要素が存在しません");return}let t="msg-".concat(this.messageIdCounter++),n=document.createElement("div");n.className="chat-message user",n.setAttribute("data-message-id",t),n.innerHTML='\n            <button class="prompt-info-btn" title="実際のプロンプトを表示">?</button>\n            <div class="message-content">'.concat(this.escapeHtml(e),'</div>\n            <div class="message-time">').concat(new Date().toLocaleTimeString(),"</div>\n        "),n.querySelector(".prompt-info-btn").addEventListener("click",()=>{this.showPromptModal(t)}),this.elements.chatMessages.appendChild(n),this.forceScroll(this.elements.chatMessages),this.currentMessageId=t,this.promptHistory.set(t,{userInput:e,actualPrompt:null,timestamp:new Date})}updateAssistantMessage(e){if(!this.elements.chatMessages){console.error("chatMessages要素が存在しません");return}let t=this.elements.chatMessages.querySelector(".chat-message.assistant:last-child");t||((t=document.createElement("div")).className="chat-message assistant",this.elements.chatMessages.appendChild(t));let n=this.replaceSvgWithReferenceMessage(e);t.innerHTML='\n            <div class="message-content">'.concat(n,'</div>\n            <div class="message-time">').concat(new Date().toLocaleTimeString(),"</div>\n        "),this.forceScroll(this.elements.chatMessages)}replaceSvgWithReferenceMessage(e){try{if(console.log("replaceSvgWithReferenceMessage 処理開始"),console.log("入力コンテンツ長:",e.length),!(e.includes("<")||e.includes(">")))return console.log("既にエスケープ済みのコンテンツ"),e;let t=e.indexOf("<?xml"),n=e.indexOf("<mxfile");if(-1===t&&-1===n)return console.log("drawioコードなし - 通常のテキスト処理"),this.escapeHtml(e);{console.log("drawioコード検出（完全または不完全）");let s=-1;s=-1!==t&&-1!==n?Math.min(t,n):-1!==t?t:n;let o=e.substring(0,s);console.log("drawio前のテキスト:",o);let l=e.indexOf("</mxfile>"),a=!1;return -1!==l?(e.substring(l+9),a=!0,console.log("完全なdrawioコード検出")):console.log("不完全なdrawioコード検出（ストリーミング中）"),a?'<div style="background: #f0f9ff; padding: 10px; border-radius: 6px; margin: 8px 0; border-left: 3px solid #1e40af;">\n                        <strong>drawioコード</strong> が生成されました<br>\n                        詳細は下部の「drawioコード」パネルおよび右側の「フロー図」パネルでご確認ください\n                    </div>':'<div style="background: #fefce8; padding: 10px; border-radius: 6px; margin: 8px 0; border-left: 3px solid #f59e0b;">\n                        <strong>drawioコード</strong> を生成中です...<br>\n                        詳細は下部の「drawioコード」パネルでリアルタイムに確認できます\n                    </div>'}}catch(t){return console.error("drawio置き換えエラー:",t),this.escapeHtml(e)}}isSvgCodeContent(e){if(e.includes("<mxfile")||e.includes("<?xml")){let t=e.match(/<\?\s*xml[\s\S]*?<\/mxfile>|<mxfile[\s\S]*?<\/mxfile>/);if(t)return t[0].length/e.length>.3}return!1}showTypingIndicator(){if(!this.elements.chatMessages){console.error("chatMessages要素が存在しません - タイピングインジケーター表示不可");return}this.hideTypingIndicator();let e=document.createElement("div");e.className="typing-indicator",e.id="typing-indicator",e.innerHTML='\n            入力中 \n            <div class="typing-dots">\n                <span></span>\n                <span></span>\n                <span></span>\n            </div>\n        ',this.elements.chatMessages.appendChild(e),this.forceScroll(this.elements.chatMessages)}hideTypingIndicator(){let e=document.getElementById("typing-indicator");e&&e.remove()}escapeHtml(e){let t=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");return(t=(t=(t=(t=(t=(t=t.replace(/\n/g,"<br>")).replace(/^([•\-\*])\s+(.+)$/gm,"<li>$2</li>")).replace(/(<li>.*<\/li>(\s*<br>)?)+/g,function(e){return'<ul style="margin: 8px 0; padding-left: 20px;">'+e.replace(/<br>/g,"")+"</ul>"})).replace(/^(\d+)\.\s+(.+)$/gm,"<li>$2</li>")).replace(/(<li>.*<\/li>(\s*<br>)?)+/g,function(e,t,n){return 0===t||">"!==n[t-1]?'<ol style="margin: 8px 0; padding-left: 20px;">'+e.replace(/<br>/g,"")+"</ol>":e})).replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>")).replace(/`([^`]+)`/g,'<code style="background: #f3f4f6; padding: 2px 4px; border-radius: 3px; font-family: monospace;">$1</code>')}clearAll(){console.log("全クリア実行"),this.elements.promptInput.value="",this.clearResults(),this.clearAttachments({skipButtonUpdate:!0}),this.updateStatus("chat","待機中"),this.updateStatus("code","待機中"),this.updateStatus("diagram","待機中"),this.elements.promptInput.dispatchEvent(new Event("input")),this.updateButtonState()}async copySvgCode(){try{if(this.elements.svgCode.classList.contains("placeholder")){console.log("drawioコードがまだ生成されていません");return}let e=this.extractPlainSvgCode();if(!e){console.log("drawioコードが見つかりません");return}await navigator.clipboard.writeText(e),console.log("drawioコードをクリップボードにコピーしました"),this.showCopyFeedback()}catch(e){console.error("コピーエラー:",e),this.fallbackCopy()}}extractPlainSvgCode(){if(console.log("extractPlainSvgCode開始"),console.log("accumulatedSvgCode存在チェック:",!!this.accumulatedSvgCode),console.log("accumulatedSvgCode長さ:",this.accumulatedSvgCode?this.accumulatedSvgCode.length:0),this.accumulatedSvgCode&&(this.accumulatedSvgCode.includes("<?xml")||this.accumulatedSvgCode.includes("<mxfile")))return console.log("accumulatedSvgCodeから取得 - 最初の100文字:",this.accumulatedSvgCode.substring(0,100)),this.accumulatedSvgCode;let e=this.elements.svgCode;if(!e)return console.warn("svgCode要素が見つかりません"),"";let t=e.innerHTML;console.log("innerHTML取得 - 最初の200文字:",t.substring(0,200)),console.log("spanタグ除去後 - 最初の200文字:",(t=t.replace(/<span[^>]*>/g,"").replace(/<\/span>/g,"")).substring(0,200));let n=document.createElement("div");n.innerHTML=t;let s=n.textContent||n.innerText||"";console.log("HTMLデコード後 - 最初の200文字:",s.substring(0,200));let o=s.indexOf("<?xml"),l=s.indexOf("<mxfile"),a=s.lastIndexOf("</mxfile>");if(console.log("検出位置 - xmlStart:",o,"mxfileStart:",l,"mxfileEnd:",a),-1!==o&&-1!==a){let e=s.substring(o,a+9);return console.log("xmlStartから抽出 - 最初の100文字:",e.substring(0,100)),e}if(-1!==l&&-1!==a){let e='<?xml version="1.0" encoding="UTF-8"?>\n'+s.substring(l,a+9);return console.log("mxfileStartから抽出（XML宣言追加） - 最初の100文字:",e.substring(0,100)),e}return console.log("drawioコードを抽出できませんでした"),null}showCopyFeedback(){let e=this.elements.copySvgBtn,t=e.querySelector(".copy-tooltip"),n=e.querySelector("span"),s=e.querySelector("i");e.classList.add("copied"),n.textContent="コピー済み",s.className="fas fa-check",t.classList.add("show"),setTimeout(()=>{e.classList.remove("copied"),n.textContent="コピー",s.className="fas fa-copy",t.classList.remove("show")},2e3)}fallbackCopy(){let e=this.extractPlainSvgCode();if(!e)return;let t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select();try{document.execCommand("copy"),console.log("フォールバック: drawioコードをコピーしました"),this.showCopyFeedback()}catch(e){console.error("フォールバックコピーも失敗:",e)}document.body.removeChild(t)}async downloadSvgFile(){try{if(this.elements.svgCode.classList.contains("placeholder")){console.log("drawioコードがまだ生成されていません");return}let e=this.extractPlainSvgCode();if(!e){console.log("drawioコードが見つかりません");return}let t=new Blob([e],{type:"application/xml;charset=utf-8"}),n=document.createElement("a"),s=URL.createObjectURL(t),o=new Date().toISOString().replace(/[:.]/g,"-").slice(0,-5),l="business-flow-".concat(o,".drawio");n.href=s,n.download=l,document.body.appendChild(n),n.click(),document.body.removeChild(n),setTimeout(()=>URL.revokeObjectURL(s),100),console.log("drawioファイルをダウンロードしました: ".concat(l)),this.showDownloadFeedback()}catch(e){console.error("ダウンロードエラー:",e),this.showError("ダウンロードに失敗しました")}}showDownloadFeedback(){let e=document.querySelector(".download-tooltip");e&&(e.style.opacity="1",e.style.transform="translateX(-50%) translateY(0)",setTimeout(()=>{e.style.opacity="0",e.style.transform="translateX(-50%) translateY(10px)"},2e3))}cleanupPromptDisplay(e){return e.replace(/\n{3,}/g,"\n\n").replace(/^[-=]{40,}$/gm,"--------").replace(/^[_━]{40,}$/gm,"--------").replace(/^#\s*[-=]+\s*$/gm,"#--------").replace(/^\s+$/gm,"")}showPromptModal(e){let t=this.promptHistory.get(e);if(!t){console.error("プロンプトデータが見つかりません:",e);return}let n='\n            <div class="prompt-section">\n                <div class="prompt-section-title">ユーザー入力</div>\n                <div class="prompt-content">'.concat(this.escapeHtml(t.userInput),"</div>\n            </div>\n        ");if(t.actualPrompt){let s=this.cleanupPromptDisplay(t.actualPrompt);n+='\n                <div class="prompt-section">\n                    <div class="prompt-section-title">実際に送信されたプロンプト</div>\n                    <div class="prompt-content">'.concat(this.escapeHtml(s),'</div>\n                    <button class="prompt-copy-btn" onclick="window.biTflowDemo.copyPrompt(\'').concat(e,'\')">\n                        <i class="fas fa-copy"></i>\n                        <span>プロンプトをコピー</span>\n                    </button>\n                </div>\n            ')}else n+='\n                <div class="prompt-section">\n                    <div class="prompt-section-title">実際に送信されたプロンプト</div>\n                    <div class="prompt-content" style="color: #9ca3af; font-style: italic;">\n                        プロンプト情報はまだ取得されていません。\n                        サーバーからの応答を待っています...\n                    </div>\n                </div>\n            ';n+='\n            <div class="prompt-section">\n                <div class="prompt-section-title">送信時刻</div>\n                <div class="prompt-content">'.concat(t.timestamp.toLocaleString(),"</div>\n            </div>\n        "),this.elements.promptModalBody.innerHTML=n,this.elements.promptModal.classList.add("show")}closePromptModal(){this.elements.promptModal.classList.remove("show")}async copyPrompt(e){let t=this.promptHistory.get(e);if(!t||!t.actualPrompt){console.error("コピーするプロンプトがありません");return}try{await navigator.clipboard.writeText(t.actualPrompt);let e=this.elements.promptModalBody.querySelector(".prompt-copy-btn");if(e){e.classList.add("copied");let t=e.querySelector("span"),n=t.textContent;t.textContent="コピーしました！",setTimeout(()=>{e.classList.remove("copied"),t.textContent=n},2e3)}}catch(e){console.error("プロンプトのコピーに失敗:",e)}}clearResults(){this.accumulatedSvgCode="",this.elements.svgCode.innerHTML="生成されたdrawioコードがここに段階的に表示されます...",this.elements.svgCode.classList.add("placeholder"),this.elements.flowDiagram.classList.remove("svg-processing","svg-ready"),this.elements.flowDiagram.innerHTML='<div class="placeholder">生成された業務フロー図がここに表示されます...</div>',this.updateTimer&&(clearTimeout(this.updateTimer),this.updateTimer=null),this.svgDisplayed=!1,this.lastDisplayedSvgLength=0}showError(e){if(!this.elements.chatMessages){console.error("chatMessages要素が存在しません - エラーメッセージ:",e);return}let t=document.createElement("div");t.className="chat-message system",t.innerHTML='\n            <div class="message-content">エラー: '.concat(this.escapeHtml(e),'</div>\n            <div class="message-time">').concat(new Date().toLocaleTimeString(),"</div>\n        "),this.elements.chatMessages.appendChild(t),this.forceScroll(this.elements.chatMessages),console.error("エラー表示:",e)}showSuccess(e){let t=document.createElement("div");t.className="completion-notification",t.innerHTML='\n            <div class="completion-content">\n                <div class="completion-icon">\n                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                        <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                    </svg>\n                </div>\n                <div class="completion-text">\n                    <div class="completion-title">'.concat(e,'</div>\n                    <div class="completion-subtitle">業務フロー図の生成が正常に完了しました</div>\n                </div>\n            </div>\n        ');let n=document.createElement("style");n.textContent="\n            .completion-notification {\n                position: fixed;\n                bottom: 24px;\n                right: 24px;\n                transform: translateX(400px);\n                background: #1a1a1a;\n                border-radius: 12px;\n                padding: 16px 20px;\n                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);\n                z-index: 10000;\n                opacity: 0;\n                transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);\n                max-width: 320px;\n            }\n            \n            .completion-notification.show {\n                opacity: 1;\n                transform: translateX(0);\n            }\n            \n            .completion-notification.hide {\n                opacity: 0;\n                transform: translateX(400px);\n            }\n            \n            .completion-content {\n                display: flex;\n                align-items: center;\n                gap: 12px;\n            }\n            \n            .completion-icon {\n                width: 32px;\n                height: 32px;\n                background: #10b981;\n                border-radius: 50%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                color: white;\n                flex-shrink: 0;\n            }\n            \n            .completion-icon svg {\n                width: 18px;\n                height: 18px;\n                stroke-width: 3;\n            }\n            \n            .completion-text {\n                display: flex;\n                flex-direction: column;\n                gap: 2px;\n            }\n            \n            .completion-title {\n                font-size: 15px;\n                font-weight: 500;\n                color: #ffffff;\n                margin-bottom: 2px;\n            }\n            \n            .completion-subtitle {\n                font-size: 13px;\n                color: #9ca3af;\n                line-height: 1.4;\n            }\n            \n            @media (max-width: 640px) {\n                .completion-notification {\n                    bottom: 16px;\n                    right: 16px;\n                    left: 16px;\n                    max-width: none;\n                }\n            }\n        ",document.querySelector("#completion-notification-styles")||(n.id="completion-notification-styles",document.head.appendChild(n)),document.body.appendChild(t),requestAnimationFrame(()=>{t.classList.add("show")}),setTimeout(()=>{t.classList.remove("show"),t.classList.add("hide"),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300)},3500),console.log("成功表示:",e)}constructor(){this.isGenerating=!1,this.currentStream=null,this.svgStarted=!1,this.accumulatedSvgCode="",this.updateTimer=null,this.svgDisplayed=!1,this.attachments=[],this.attachmentIdCounter=0,this.currentGraph=null,this.parsedCells=new Set,this.mxgraphInitialized=!1,this.promptHistory=new Map,this.messageIdCounter=0,this.sessionId=this.getOrCreateSessionId(),console.log("セッションID:",this.sessionId),this.chatSectionRatio=this.getStoredPanelRatio(),this.initializeElements(),this.applyPanelSplit(this.chatSectionRatio),this.setupPanelResizer(),this.attachEventListeners(),this.updateButtonState(),this.checkConnection(),console.log("BiT-Flow プロキシデモ初期化完了")}}async function u(){p||(window.addEventListener("error",e=>{console.error("グローバルエラー:",e.error)}),window.addEventListener("unhandledrejection",e=>{console.error("未処理Promise拒否:",e.reason)}),p=!0),await new Promise(e=>{let t=Date.now(),n=()=>{if("undefined"!=typeof mxGraph){e();return}if(Date.now()-t>=5e3){console.warn("MXGraphライブラリの読み込みに時間がかかっています。継続して初期化を試みます。"),e();return}setTimeout(n,250)};n()});try{let e=new g;return window.biTflowDemo=e,"undefined"!=typeof mxClient&&(null==mxClient?void 0:mxClient.VERSION)&&console.log("MXGraphバージョン:",mxClient.VERSION),e}catch(e){return console.error("BiT-Flow プロキシデモ初期化失敗:",e),null}}function f(){return(0,o.useEffect)(()=>(u().catch(e=>{console.error("BiT-Flow UI 初期化エラー:",e)}),()=>{window.biTflowDemo&&"function"==typeof window.biTflowDemo.stopGenerating&&window.biTflowDemo.stopGenerating(),window.biTflowDemo=null}),[]),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"demo-container",children:[(0,s.jsxs)("div",{className:"left-panel",children:[(0,s.jsx)(l,{}),(0,s.jsx)(r,{}),(0,s.jsx)(i,{})]}),(0,s.jsx)(a,{})]}),(0,s.jsx)(c,{})]})}},4484:function(e,t,n){"use strict";n.d(t,{z1:function(){return h}});var s=n(9315),o=n.n(s),l=n(7800);let a=/\.(txt|md|csv|json|xml|drawio|plantuml|pu|uml|svg)$/i,i=/\.docx$/i,r=["application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel.sheet.macroenabled.12"],c=/\.(xlsx|xlsm|xls)$/i,d=null;async function h(e){return e&&("application/vnd.openxmlformats-officedocument.wordprocessingml.document"===(e.type||"").toLowerCase()||i.test(e.name||""))?{content:await p(e),encoding:"text"}:!function(e){if(!e)return!1;let t=(e.type||"").toLowerCase();return!!r.includes(t)||c.test(e.name||"")}(e)?e&&("application/pdf"===(e.type||"").toLowerCase()||/\.pdf$/i.test(e.name||""))?{content:await g(e),encoding:"text"}:new Promise((t,n)=>{let s=new FileReader,o=function(e){if(!e)return!1;let t=e.type||"";return!!(t.startsWith("text/")||["application/json","application/xml","text/xml","image/svg+xml"].includes(t))||a.test(e.name||"")}(e);s.onload=()=>{let e=s.result||"";if(o){t({content:"string"==typeof e?e:"",encoding:"text"});return}t({content:"string"==typeof e&&e.split(",")[1]||"",encoding:"base64"})},s.onerror=()=>{n(s.error||Error("ファイル読み込みに失敗しました"))},o?s.readAsText(e):s.readAsDataURL(e)}):{content:await m(e),encoding:"text"}}async function p(e){let t=await e.arrayBuffer(),n=(await o().loadAsync(t)).file("word/document.xml");if(!n)throw Error("Wordファイルの本文（word/document.xml）が見つかりませんでした");let s=await n.async("text"),l=new DOMParser().parseFromString(s,"application/xml");if(l.getElementsByTagName("parsererror").length>0)throw Error("WordファイルのXML解析に失敗しました");let a=Array.from(l.getElementsByTagName("w:p")).map(e=>(function(e){let t=[];return Array.from(e.childNodes).forEach(e=>{var n;if(e.nodeType!==Node.ELEMENT_NODE)return;let s=null===(n=e.tagName)||void 0===n?void 0:n.toLowerCase();if("w:r"===s){Array.from(e.getElementsByTagName("w:t")).forEach(e=>{e.textContent&&t.push(e.textContent)});let n=e.getElementsByTagName("w:br");n.length>0&&t.push("\n".repeat(n.length))}else"w:tab"===s?t.push("	"):"w:br"===s&&t.push("\n")}),t.join("").replace(/\t/g,"    ")})(e)).map(e=>e.replace(/\s+$/u,"")).join("\n").replace(/\n{3,}/g,"\n\n").trim();if(!a)throw Error("Wordファイルからテキストを抽出できませんでした。");return a}async function m(e){let t=await e.arrayBuffer(),n=l.ij(t,{type:"array"});if(!n.SheetNames||0===n.SheetNames.length)throw Error("Excelファイルにシートが見つかりませんでした。");let s=n.SheetNames.map(e=>{let t=n.Sheets[e];if(!t)return null;let s=l.P6.sheet_to_json(t,{header:1,raw:!1});if(!s.length)return"【シート: ".concat(e,"】\n(空のシート)");let o=s.map(e=>(e||[]).map(e=>(function(e){if(null==e)return"";if(e instanceof Date)return e.toISOString();if("number"==typeof e||"boolean"==typeof e)return String(e);if("string"==typeof e)return e.replace(/\s+/g," ").trim();if("object"==typeof e)try{return JSON.stringify(e)}catch(e){}return""})(e)).join("	").trimEnd()).join("\n");return"【シート: ".concat(e,"】\n").concat(o)}).filter(Boolean).join("\n\n").trim();if(!s)throw Error("Excelファイルからテキストを抽出できませんでした。");return s}async function g(e){let t=await u(),n=await e.arrayBuffer();console.log("data"),console.log(n);let s=t.getDocument({data:n}),o=await s.promise;console.log("pdfDocument"),console.log(o);let l=[];for(let e=1;e<=o.numPages;e+=1){let t=await o.getPage(e),n=(await t.getTextContent()).items.map(e=>"str"in e?e.str:"").join(" ").trim();n&&l.push(n)}let a=l.join("\n\n").trim();if(!a)throw Error("PDFからテキストを抽出できませんでした。画像ベースのpdfは非対応です。pdf view等でpdf内の文字列をテキストとして認識できること（=テキストベースのpdf）を確認してください。）");return a}async function u(){return d||(d=n.e(634).then(n.bind(n,2392)).then(e=>{if("undefined"!=typeof Worker&&(null==e?void 0:e.GlobalWorkerOptions))try{let t=e.GlobalWorkerOptions;t.workerPort||(t.workerPort=new Worker(n.tu(new URL(n.p+n.u(357),n.b)),{type:void 0}))}catch(e){console.warn("PDF worker 初期化に失敗しました:",e)}return e})),d}},1266:function(e,t,n){"use strict";var s;n.d(t,{b:function(){return l}});let o=(null===(s=n(357).env.NEXT_PUBLIC_PROXY_BASE_URL)||void 0===s?void 0:s.replace(/\/$/,""))||"",l={health:"".concat(o,"/health"),messages:e=>"".concat(o,"/sessions/").concat(e,"/flows"),messagesBatch:"".concat(o,"/api/claude/messages-batch")}}},function(e){e.O(0,[425,315,971,23,744],function(){return e(e.s=5539)}),_N_E=e.O()}]);