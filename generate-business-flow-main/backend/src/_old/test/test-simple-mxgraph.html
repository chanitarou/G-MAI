<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Simple MXGraph Test</title>
    <script type="text/javascript">
        window.mxLoadResources = false;
        window.mxBasePath = 'https://jgraph.github.io/mxgraph/javascript/src';
    </script>
    <script type="text/javascript" src="https://jgraph.github.io/mxgraph/javascript/mxClient.js"></script>
</head>
<body>
    <h1>MXGraph シンプルテスト</h1>
    <button onclick="testBasicGraph()">基本グラフをテスト</button>
    <button onclick="testDrawioXml()">DrawioのXMLをテスト</button>
    <div id="graphContainer" style="width: 800px; height: 600px; border: 1px solid #ccc; background: white; margin-top: 20px;"></div>
    <pre id="log" style="margin-top: 20px; padding: 10px; background: #f0f0f0;"></pre>
    
    <script type="text/javascript">
        function log(message) {
            const logEl = document.getElementById('log');
            logEl.textContent += message + '\n';
            console.log(message);
        }
        
        window.onload = function() {
            log('ページ読み込み完了');
            log('mxGraph定義: ' + (typeof mxGraph !== 'undefined'));
            log('mxUtils定義: ' + (typeof mxUtils !== 'undefined'));
            log('mxCodec定義: ' + (typeof mxCodec !== 'undefined'));
        };
        
        function testBasicGraph() {
            log('\n=== 基本グラフテスト ===');
            const container = document.getElementById('graphContainer');
            container.innerHTML = '';
            
            try {
                const graph = new mxGraph(container);
                graph.setEnabled(false);
                log('グラフ作成成功');
                
                const parent = graph.getDefaultParent();
                graph.getModel().beginUpdate();
                try {
                    const v1 = graph.insertVertex(parent, null, 'タスク1', 20, 20, 100, 40);
                    const v2 = graph.insertVertex(parent, null, 'タスク2', 200, 20, 100, 40);
                    graph.insertEdge(parent, null, '', v1, v2);
                    log('要素追加成功');
                } finally {
                    graph.getModel().endUpdate();
                }
                log('グラフ表示完了');
            } catch (e) {
                log('エラー: ' + e.message);
                console.error(e);
            }
        }
        
        function testDrawioXml() {
            log('\n=== DrawioのXMLテスト ===');
            const container = document.getElementById('graphContainer');
            container.innerHTML = '';
            
            // Claude APIから生成される典型的なdrawio XML
            const drawioXML = `<?xml version="1.0" encoding="UTF-8"?>
<mxfile host="app.diagrams.net">
  <diagram name="Page-1" id="test">
    <mxGraphModel dx="1422" dy="794" grid="1" gridSize="10">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="task1" value="開始" style="ellipse;whiteSpace=wrap;html=1;fillColor=#f5faff;strokeColor=#2196F3;" vertex="1" parent="1">
          <mxGeometry x="100" y="100" width="80" height="80" as="geometry" />
        </mxCell>
        <mxCell id="task2" value="タスク処理" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5faff;strokeColor=#2196F3;" vertex="1" parent="1">
          <mxGeometry x="250" y="120" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="edge1" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="task1" target="task2">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>`;
            
            try {
                const graph = new mxGraph(container);
                graph.setEnabled(false);
                log('グラフ作成成功');
                
                // XMLをパース
                const parser = new DOMParser();
                const doc = parser.parseFromString(drawioXML, 'text/xml');
                log('XML解析成功');
                
                const codec = new mxCodec();
                const mxGraphModel = doc.querySelector('mxGraphModel');
                
                if (mxGraphModel) {
                    log('mxGraphModel要素発見');
                    codec.decode(mxGraphModel, graph.getModel());
                    log('デコード成功');
                    
                    // グラフの内容を確認
                    const cells = graph.getModel().cells;
                    let cellCount = 0;
                    for (let id in cells) {
                        if (cells[id]) cellCount++;
                    }
                    log('セル数: ' + cellCount);
                } else {
                    log('mxGraphModel要素が見つかりません');
                }
                
                graph.refresh();
                log('グラフ更新完了');
                
            } catch (e) {
                log('エラー: ' + e.message);
                console.error(e);
            }
        }
    </script>
</body>
</html>