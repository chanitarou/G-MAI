<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>フロー図デバッグ</title>
    <script type="text/javascript">
        window.mxLoadResources = false;
        window.mxBasePath = 'https://jgraph.github.io/mxgraph/javascript/src';
    </script>
    <script type="text/javascript" src="https://jgraph.github.io/mxgraph/javascript/mxClient.js"></script>
</head>
<body>
    <h1>フロー図表示デバッグ</h1>
    <button onclick="testSimpleGraph()">シンプルなグラフをテスト</button>
    <button onclick="testDrawioCode()">drawioコードをテスト</button>
    <div id="graphContainer" style="width: 800px; height: 600px; border: 1px solid #ccc; background: white; margin-top: 20px;"></div>
    <pre id="logArea" style="margin-top: 20px; padding: 10px; background: #f0f0f0; max-height: 200px; overflow-y: auto;"></pre>
    
    <script type="text/javascript">
        function log(message) {
            const logArea = document.getElementById('logArea');
            logArea.textContent += message + '\n';
            console.log(message);
        }
        
        window.onload = function() {
            log('ページ読み込み完了');
            log('mxGraph定義: ' + (typeof mxGraph !== 'undefined'));
            log('mxClient定義: ' + (typeof mxClient !== 'undefined'));
            if (typeof mxClient !== 'undefined' && mxClient.VERSION) {
                log('mxGraphバージョン: ' + mxClient.VERSION);
            }
        };
        
        function testSimpleGraph() {
            log('\n=== シンプルなグラフテスト開始 ===');
            const container = document.getElementById('graphContainer');
            container.innerHTML = '';
            
            try {
                const graph = new mxGraph(container);
                graph.setEnabled(false);
                log('グラフ作成成功');
                
                const parent = graph.getDefaultParent();
                graph.getModel().beginUpdate();
                try {
                    const v1 = graph.insertVertex(parent, null, '開始', 20, 20, 80, 30, 
                        'fillColor=#2196F3;strokeColor=#0D47A1;fontColor=#ffffff;shape=ellipse');
                    const v2 = graph.insertVertex(parent, null, 'タスク1', 150, 20, 100, 40,
                        'fillColor=#f5faff;strokeColor=#2196F3;fontColor=#000000');
                    const v3 = graph.insertVertex(parent, null, 'DB', 300, 20, 80, 60,
                        'shape=cylinder;fillColor=#2196F3;strokeColor=#0D47A1;fontColor=#ffffff');
                    
                    graph.insertEdge(parent, null, '', v1, v2);
                    graph.insertEdge(parent, null, '', v2, v3);
                    
                    log('要素追加成功');
                } finally {
                    graph.getModel().endUpdate();
                }
                log('グラフ表示完了');
            } catch (e) {
                log('エラー: ' + e.message);
                console.error(e);
            }
        }
        
        function testDrawioCode() {
            log('\n=== drawioコードテスト開始 ===');
            const container = document.getElementById('graphContainer');
            container.innerHTML = '';
            
            // 最小限のdrawioコード
            const drawioXML = `<?xml version="1.0" encoding="UTF-8"?>
<mxfile host="app.diagrams.net" version="24.7.8">
  <diagram name="Test" id="test-123">
    <mxGraphModel dx="1400" dy="900" grid="1" gridSize="10">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="2" value="開始" style="ellipse;whiteSpace=wrap;html=1;fillColor=#2196F3;strokeColor=#0D47A1;fontColor=#ffffff;" vertex="1" parent="1">
          <mxGeometry x="100" y="100" width="80" height="80" as="geometry" />
        </mxCell>
        <mxCell id="3" value="タスク" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5faff;strokeColor=#2196F3;" vertex="1" parent="1">
          <mxGeometry x="250" y="120" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="2" target="3">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>`;
            
            try {
                const graph = new mxGraph(container);
                graph.setEnabled(false);
                log('グラフ作成成功');
                
                // XMLをパース
                const parser = new DOMParser();
                const doc = parser.parseFromString(drawioXML, 'text/xml');
                log('XML解析成功');
                
                const codec = new mxCodec();
                const mxGraphModel = doc.querySelector('mxGraphModel');
                
                if (mxGraphModel) {
                    log('mxGraphModel要素発見');
                    codec.decode(mxGraphModel, graph.getModel());
                    log('デコード成功');
                } else {
                    log('mxGraphModel要素が見つかりません');
                }
                
                graph.refresh();
                log('グラフ更新完了');
                
            } catch (e) {
                log('エラー: ' + e.message);
                console.error(e);
            }
        }
    </script>
</body>
</html>